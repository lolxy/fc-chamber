<div class="contact-wrap">
  <!-- hbox layout -->
  <div class="hbox">
    <div class="container contact-container padder-v">
      <div class="contact-main">
        <main-menu></main-menu>
        <div class="row" :class="{'row-3cols': currentSession.scene == 'team'}">
          <div class="column col-md-3 col-left no-padder">
            <div class="panel no-border contact-sessions-list-panel">
              <div class="panel-body no-padder">
                <div class="list-group contact-sessions-list-group">
                  <template v-for="session in sessions">
                    <div class="list-group-item" :class="{'active': session.id === currentSession.id, 'focus': session.id === currentCtxSession.id}" v-if="session.scene == 'p2p'">
                      <div class="list-group-item-inner clear" @click="switchSession(session.id)" @contextmenu.prevent="openContextMenu(session, $event)">
                        <a class="pull-left thumb-sm m-r">
                          <template v-if="users[session.id]">
                            <avatar :src="users[session.id].avatar" :size="80" class="r r-2x" v-if="users[session.id].avatar"></avatar>
                            <avatar :src="null" :size="80" class="r r-2x" v-else></avatar>
                          </template>
                          <template v-else>
                            <avatar :src="null" :size="80" class="r r-2x"></avatar>
                          </template>
                        </a>
                        <b class="badge bg-danger pull-right" v-if="session.unread && session.id !== currentSession.id">{{ session.unread }}</b>
                        <p class="m-b-xxs session-title" v-if="users[session.id]">{{ users[session.id].nick }}</p>
                        <p class="last-msg m-n" v-if="session.lastMsg">{{ latestMsg(session.lastMsg) }}</p>
                      </div>
                      <a class="btn-close" @click="removeSession(session)"><i class="fa fa-close"></i></a>
                    </div>
                    <div class="list-group-item" :class="{'active': session.id === currentSession.id, 'focus': session.id === currentCtxSession.id}" v-if="session.scene == 'team'">
                      <div class="list-group-item-inner clear" @click="switchSession(session.id)" @contextmenu.prevent="openContextMenu(session, $event)">
                        <a class="pull-left thumb-sm m-r">
                          <template v-if="teams[session.id]">
                            <avatar :src="teams[session.id].avatar" :size="80" class="r r-2x" v-if="teams[session.id].avatar"></avatar>
                            <avatar :src="null" :size="80" class="r r-2x" v-else></avatar>
                          </template>
                          <template v-else>
                            <avatar :src="null" :size="80" class="r r-2x"></avatar>
                          </template>
                        </a>
                        <b class="badge bg-danger pull-right" v-if="session.unread && session.id !== currentSession.id">{{ session.unread }}</b>
                        <p class="m-b-xxs session-title" v-if="teams[session.id]">{{ teams[session.id].name }}</p>
                        <p class="last-msg m-n" v-if="session.lastMsg">{{ latestMsg(session.lastMsg) }}</p>
                      </div>
                      <a class="btn-close" @click="removeSession(session)"><i class="fa fa-close"></i></a>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </div>
          <div class="column col-main no-padder" :class="{'col-md-9': currentSession.scene == 'p2p', 'col-md-6': currentSession.scene == 'team'}">
            <chat-panel v-for="session in sessions" :currentSessionId="session.id" v-if="session.id === currentSession.id" :id="`panel-chat-${session.to}`" :key="session.id"></chat-panel>
          </div>
          <div class="column col-md-3 col-right no-padder" v-if="currentSession.scene == 'team'">
            <div class="panel no-border session-team-notice-panel">
              <div class="panel-heading">
                <strong>群公告</strong>
                <span class="pull-right" v-if="isTeamManager">
                  <a class="btn-edit-notice"><i class="fa fa-edit" @click="openTeamNoticeEditorDialog"></i></a>
                </span>
              </div>
              <div class="panel-body" v-if="teamMembers[currentSession.id]">
                <p>{{ teams[currentSession.id].intro }}</p>
              </div>
            </div>
            <div class="panel no-border session-team-members-panel">
              <div class="panel-heading">
                <strong>群成员 <span v-if="teamMembers[currentSession.id]">( {{ teamMembers[currentSession.id].length }}人 )</span></strong>
                <span class="pull-right" v-if="canInvite || isTeamManager"><a class="btn-add-members" @click="openAddTeamMemberesDialog"><i class="fa fa-plus-square"></i> 添加</a></span>
              </div>
              <div class="panel-body no-padder">
                <ul class="list-group m-b-none" v-if="teamMembers[currentSession.id]">
                  <template v-for="user in teamMembers[currentSession.id]">
                    <template v-if="users[`p2p-${user.account}`]">
                      <li class="list-group-item" :class="{'active': user.account == currentUserId, 'focus': user.account == currentTeamMemberCtxUser.account}" @click="openUserProfile(user.account)" @contextmenu.prevent="openTeamMemberContextMenu(user, $event)">
                        <div class="clear">
                          <a class="pull-left thumb-wrap m-r-sm">
                            <avatar :src="users[`p2p-${user.account}`].avatar" :size="60" class="r r-2x" v-if="users[`p2p-${user.account}`].avatar"></avatar>
                            <avatar :src="null" :size="60" class="r r-2x" v-else></avatar>
                          </a>
                          <p class="user-nick m-b-xxs">
                            <template v-if="user.nickInTeam">{{ user.nickInTeam }}</template>
                            <template v-else>{{ users[`p2p-${user.account}`].nick }}</template>
                          </p>
                          <i class="fa fa-user" :class="`icon-${user.type}`" v-if="user.type == 'owner' || user.type == 'manager'"></i>
                        </div>
                      </li>
                    </template>
                  </template>
                </ul>
              </div>
              <div class="panel-footer" v-if="teamMembers[currentSession.id]">
                <template v-if="isTeamOwner">
                  <a class="btn-leave-team text-danger" @click="dismissTeam">解散该群</a>
                </template>
                <template v-else>
                  <a class="btn-leave-team text-danger" @click="leaveTeam">退出群聊</a>
                </template>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- /hbox layout -->

  <el-dialog v-model="profileDialogVisible" size="small" v-if="currentUserId" :modal-append-to-body="false">
    <user-profile :userId="currentUserId" v-on:close="profileDialogVisible = false"></user-profile>
  </el-dialog>

  <el-dialog v-model="teamProfileDialogVisible" size="medium" v-if="currentTeamId" :modal-append-to-body="false">
    <team-profile :teamid="currentTeamId" v-on:insertSession="teamProfileDialogVisible = false" v-on:openTeamMembersDialog="openTeamMembersDialog"></team-profile>
  </el-dialog>

  <el-dialog v-model="teamMembersDialogVisible" size="medium" v-if="currentTeamId" :modal-append-to-body="false">
    <div class="team-members-list-wrap">
      <ul class="list-group m-b-none">
        <template v-for="user in teamMembers[currentSession.id]">
          <template v-if="users[`p2p-${user.account}`]">
            <li class="list-group-item" :class="{'active': user.account == currentUserId}" @click="openUserProfile(user.account)">
              <div class="clear">
                <a class="pull-left m-r-sm">
                  <avatar :src="users[`p2p-${user.account}`].avatar" :size="60" class="r r-2x" v-if="users[`p2p-${user.account}`].avatar"></avatar>
                  <avatar :src="null" :size="60" class="r r-2x" v-else></avatar>
                </a>
                <p class="m-b-xxs">
                  <template v-if="user.nickInTeam">{{ user.nickInTeam }}</template>
                  <template v-else>{{ users[`p2p-${user.account}`].nick }}</template>
                </p>
              </div>
            </li>
          </template>
        </template>
      </ul>
    </div>
  </el-dialog>

  <el-dialog v-model="addTeamMembersDialogVisible" size="medium" :modal-append-to-body="false">
    <team-members-manager v-on:closeTeamMembersManager="closeAddTeamMemberesDialog" mode="addmore"></team-members-manager>
  </el-dialog>

  <el-dialog title="群公告" v-model="teamNoticeEditorDialogVisible" size="tiny" :modal-append-to-body="false">
    <el-input type="textarea" :rows="4" placeholder="请输入群公告" v-model="teamNoticeForm.notice"></el-input>
    <div slot="footer" class="dialog-footer">
      <el-button @click="closeTeamNoticeEditorDialog">取 消</el-button>
      <el-button type="primary" @click="saveTeamNotice">保存更改</el-button>
    </div>
  </el-dialog>

  <context-menu id="context-menu" ref="sessionCtxMenu" @ctx-close="onCtxClose" @ctx-cancel="onCtxCancel">
    <template v-if="currentCtxSession.id">
      <template v-if="currentCtxSession.scene === 'p2p'">
        <li><a @click="openUserProfile(currentCtxSession.to)">查看资料</a></li>
        <li><a @click="removeSession(currentCtxSession)">移除该会话</a></li>
      </template>
      <template v-if="currentCtxSession.scene === 'team'">
        <li><a @click="openTeamProfile(currentCtxSession.to)">查看群资料</a></li>
        <!-- <li>
          <a>群消息设置</a>
          <ul class="context-submenu">
            <li><a>submenu 01</a></li>
            <li><a>submenu 02</a></li>
          </ul>
        </li> -->
        <li><a @click="removeSession(currentCtxSession)">移除该会话</a></li>
      </template>
    </template>
  </context-menu>

  <context-menu id="team-members-context-menu" ref="teamMembersCtxMenu" @ctx-close="onTeamMemberCtxClose" @ctx-cancel="onTeamMemberCtxCancel">
    <template v-if="currentTeamMemberCtxUser.account">
      <li><a @click="openUserProfile(currentTeamMemberCtxUser.account)">查看资料</a></li>
      <template v-if="isTeamOwner">
        <li v-if="currentTeamMemberCtxUser.type == 'manager'"><a @click="removeThisTeamManager(currentTeamMemberCtxUser)">取消管理员</a></li>
        <li v-else><a @click="setThisTeamManager(currentTeamMemberCtxUser)">设为管理员</a></li>
      </template>
      <template v-if="isTeamManager">
        <li v-if="currentTeamMemberCtxUser.type !== 'owner' && currentTeamMemberCtxUser.account !== myAccid">
          <a class="text-danger" @click="removeThisTeamMember(currentTeamMemberCtxUser)">移除该成员</a>
        </li>
      </template>
    </template>
  </context-menu>
</div>
